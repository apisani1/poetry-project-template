name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write
  id-token: write

jobs:

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['{{ cookiecutter.python_version }}']

    steps:
      - uses: actions/checkout@v4

      {% raw %}
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      {% endraw %}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          poetry --version

      - name: Install dependencies
        run: |
          poetry install --with test,dev --no-interaction
          poetry show

      - name: Run tests
        run: |
            poetry run python -c "import sys; print(sys.path)"  # Debug Python path
            poetry run pytest -v  # Add -v for verbose output

  release:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '{{ cookiecutter.python_version }}'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Determine release type
        id: release-type
        run: |
          {% raw %}
          if [[ ${{ github.ref }} =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+(\.post[0-9]+)?$ ]]; then
            echo "type=release" >> $GITHUB_OUTPUT
          elif [[ ${{ github.ref }} =~ ^refs/tags/v.*-alpha|beta|rc ]]; then
            echo "type=prerelease" >> $GITHUB_OUTPUT
          else
            echo "type=draft" >> $GITHUB_OUTPUT
          fi
          {% endraw %}

      - name: Extract release notes from tag
        id: release-notes
        run: |
          {% raw %}
          VERSION=${GITHUB_REF#refs/tags/v}
          {% endraw %}
          echo "Release version: $VERSION"

          echo "Extracting message from tag v$VERSION..."

          # Extract the message from the annotated tag
          git tag -l --format='%(contents)' "v$VERSION" > RELEASE_NOTES.md

          # Check if the tag message was extracted
          if [ ! -s RELEASE_NOTES.md ]; then
            echo "Warning: Could not extract tag message for v$VERSION"
            echo "Creating simple release notes..."
            echo "# Release v$VERSION" > RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "See CHANGELOG.md for details." >> RELEASE_NOTES.md
          fi

          echo "Release notes content:"
          cat RELEASE_NOTES.md

      - name: Build package
        run: poetry build

      - name: Test PyPI release
        {% raw %}
        if: steps.release-type.outputs.type != 'release'
        {% endraw %}
        env:
          {% raw %}
          POETRY_PYPI_TOKEN_TESTPYPI: ${{ secrets.TEST_PYPI_TOKEN }}
          {% endraw %}
        run: |
          poetry config repositories.testpypi https://test.pypi.org/legacy/
          poetry publish -r testpypi

      - name: Test installation from TestPyPI
        {% raw %}
        if: steps.release-type.outputs.type != 'release'
        {% endraw %}
        continue-on-error: false
        run: |
          # Create test environment
          python -m venv test_env
          source test_env/bin/activate

          # Install package from TestPyPI
          pip install --index-url https://test.pypi.org/simple/ \
              --extra-index-url https://pypi.org/simple \
              {{ cookiecutter.package_name }}

          # Set up Python environment
          SITE_PACKAGES=$(python -c "import site; print(site.getsitepackages()[0])")
          export PYTHONPATH="${SITE_PACKAGES}:${PYTHONPATH:-}"

          # Test import and version (avoiding f-string with cookiecutter variables)
          python -c "import {{ cookiecutter.package_name }}; print('Installed version: ' + {{ cookiecutter.package_name }}.__version__)"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          body_path: RELEASE_NOTES.md
          {% raw %}
          draft: ${{ steps.release-type.outputs.type == 'draft' }}
          prerelease: ${{ steps.release-type.outputs.type == 'prerelease' }}
          token: ${{ secrets.GITHUB_TOKEN }}
          {% endraw %}

      - name: Publish to PyPI
        {% raw %}
        if: steps.release-type.outputs.type == 'release'
        {% endraw %}
        env:
          {% raw %}
          POETRY_PYPI_TOKEN_PYPI: ${{ secrets.PYPI_TOKEN }}
          {% endraw %}
        run: poetry publish

      - name: Update ReadTheDocs
        {% raw %}
        if: steps.release-type.outputs.type == 'release'
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          TAG_NAME="v$VERSION"

          echo "Activating version $TAG_NAME via API..."
          curl -s -X PATCH \
            -H "Authorization: Token ${{ secrets.RTD_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"active": true}' \
            "https://readthedocs.org/api/v3/projects/langchain-prolog/versions/$TAG_NAME/" || true
        continue-on-error: true
        {% endraw %}